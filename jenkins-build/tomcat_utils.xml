<project>
    <macrodef name="deploy-war-on-tomcat-server">
        <attribute name="applicationName" default="${TOMCAT.APPLICATION.NAME}" />
        <attribute name="warFile" default="${WAR-FILE}" />
        <sequential>
            <undeploy-war-on-tomcat-server applicationName="@{applicationName}" warFile="@{warFile}" />
            <if>
                <os family="unix" />
                <then>
                    <exec executable="curl" dir="${WORKSPACE}" output="${LOG.DIR}/war_deploy.log">
                        <arg line="--upload-file @{warFile} http://${TOMCAT.USERNAME}:${TOMCAT.PASSWORD}@${TOMCAT.SERVER.ADDRESS}:${TOMCAT.SERVER.PORT}/manager/text/deploy?path=/@{applicationName}"/>
                    </exec>
                </then>
                <else>
                    <get quiet="true" src="http://${TOMCAT.SERVER.ADDRESS}:${TOMCAT.SERVER.PORT}/manager/text/deploy?path=/@{applicationName}&amp;war=@{warFile}" username="${TOMCAT.USERNAME}" password="${TOMCAT.PASSWORD}" dest="${LOG.DIR}/war_deploy.log"/>
                </else>
            </if>

            <loadfile property="war_deploy_log" srcfile="${LOG.DIR}/war_deploy.log"/>
            <condition property="war_deploy.success">
                <matches pattern="OK.*" string="${war_deploy_log}"/>
            </condition>

            <fail message="War deployment failed" unless="war_deploy.success" />
        </sequential>
    </macrodef>

    <macrodef name="undeploy-war-on-tomcat-server">
        <attribute name="applicationName" default="${TOMCAT.APPLICATION.NAME}" />
        <attribute name="warFile" default="${WAR-FILE}" />
        <sequential>
            <if>
                <os family="unix" />
                <then>
                    <exec executable="curl" dir="${WORKSPACE}" output="${LOG.DIR}/war_undeploy.log">
                        <arg line="http://${TOMCAT.USERNAME}:${TOMCAT.PASSWORD}@${TOMCAT.SERVER.ADDRESS}:${TOMCAT.SERVER.PORT}/manager/text/undeploy?path=/@{applicationName} || true"/>
                    </exec>
                </then>
                <else>
                    <get quiet="true" src="http://${TOMCAT.SERVER.ADDRESS}:${TOMCAT.SERVER.PORT}/manager/text/undeploy?path=/@{applicationName}" username="${TOMCAT.USERNAME}" password="${TOMCAT.PASSWORD}" dest="${LOG.DIR}/war_undeploy.log"/>
                </else>
            </if>
       </sequential>
    </macrodef>
</project>
