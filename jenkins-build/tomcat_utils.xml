<?xml version="1.0"?>

<!-- Works with Ant 1.7.0 and higher -->
<project basedir=".">

<target name="deploy-war-on-tomcat-server">
    <!-- TODO: Add attributes to make it more dynamic -->
    <if>
        <equals arg1="${tomcat.war_deployment.enabled}" arg2="true" />
        <then>
            <exec executable="curl" output="${general.log_dir}/war_undeploy.log">
                <arg line="'http://${tomcat.username}:${tomcat.password}@{tomcat.server.address}:{tomcat.server.port}/manager/text/undeploy?path=/${tomcat.application.name}' || true"/>
            </exec>

            <exec executable="curl" output="${general.log_dir}/war_deploy.log">
                <arg line="curl --upload-file ${war_file} 'http://${tomcat.password}@{tomcat.server.address}:{tomcat.server.port}/manager/text/deploy?path=/${tomcat.application.name}'"/>
            </exec>

<!--            <get src="http://${tomcat.server.address}:${tomcat.server.port}/manager/text/stop?path=/${tomcat.application.name}" username="${tomcat.username}" password="${tomcat.password}" dest="${general.log_dir}/war_undeploy.log" />
            <get src="http://${tomcat.server.address}:${tomcat.server.port}/manager/text/undeploy?path=/${tomcat.application.name}" username="${tomcat.username}" password="${tomcat.password}" dest="${general.log_dir}/war_undeploy.log" />
            <get src="http://${tomcat.server.address}:${tomcat.server.port}/manager/text/deploy?path=/${tomcat.application.name}&amp;war=${war_file}" username="${tomcat.username}" password="${tomcat.password}" dest="${general.log_dir}/war_deploy.log" />
-->
            <loadfile property="war_deploy_log" srcfile="${general.log_dir}/war_deploy.log"/>
            <condition property="war_deploy.success">
                <matches pattern="OK.*" string="${war_deploy_log}"/>
            </condition>

            <fail message="War deployment failed" unless="war_deploy.success" />
        </then>
    </if>
</target>

</project>
