<?xml version="1.0"?>

<!-- Works with Ant 1.7.0 and higher -->
<project basedir=".">
    <target name="generate_code_analysis_reports">
        <if>
            <not>
                <equals arg1="${code.analysis.enabled}" arg2="true" />
            </not>
            <then>
                <echo level="info" message="Code Analysis Reporting disabled" />
            </then>
            <else>
                <script language="javascript"><![CDATA[
                    var list = project.getProperty('code.analysis.exclude.list');
                    var excludeRegexString = '\\\\bmedias\\\\b';
                    if (list) {
                        excludeRegexString += '|\\\\b' + list.replace(/\s*,\s*/g, '\\\\b|\\\\b') + '\\\\b';
                    }
                    project.setProperty('code.analysis.exclude.regex', excludeRegexString);

                    var inputDir = project.getProperty('code.analysis.input.dir');
                    if (!inputDir && inputDir.charAt(0) != '#') {
                        project.setProperty('code.analysis.input.dir', project.getProperty('servoy.solution_under_testing'));
                    }
                ]]></script>
                <echo level="verbose" message="plato exclude regex=${code.analysis.exclude.regex}" />

                <antcall target="execute_plato_for_code_analysis" />
            </else>
        </if>
    </target>

    <!-- create a code analysis report using plato-->
    <target name="execute_plato_for_code_analysis" depends="install_plato">
        <echo level="info" message="code analysis of ${code.analysis.input.dir} into output dir ${code.analysis.result.dir}"/>

        <condition property="code.analysis.internal.linter-option" value="--jshint" else="--eslint">
            <equals arg1="${code.analysis.linter}" arg2="jshint" />
        </condition>
        <condition property="code.analysis.internal.linter-option.value" value="${code.analysis.settings.jshint}" else="${code.analysis.settings.eslint}">
            <equals arg1="${code.analysis.linter}" arg2="jshint" />
        </condition>

        <echo level="info" message='plato.cmd --recurse --dir ${code.analysis.result.dir} --exclude "${code.analysis.exclude.regex}" ${code.analysis.internal.linter-option} ${code.analysis.internal.linter-option.value} ${code.analysis.input.dir}' />
        <exec executable="plato.cmd" dir="${WORKSPACE}" osfamily="windows" failonerror="true">
            <arg value="--recurse"/>
            <arg value="--dir"/>
            <arg value="${code.analysis.result.dir}"/>
            <arg value="--exclude"/>
            <arg value='"${code.analysis.exclude.regex}"'/>
            <arg value="${code.analysis.internal.linter-option}"/>
            <arg value='${code.analysis.internal.linter-option.value}'/>
            <arg value="${code.analysis.input.dir}"/>
        </exec>
        <exec executable="plato" dir="${WORKSPACE}" osfamily="unix" failonerror="true">
            <arg value="--recurse"/>
            <arg value="--dir"/>
            <arg value="${code.analysis.result.dir}"/>
            <arg value="--exclude"/>
            <arg value='"${code.analysis.exclude.regex}"'/>
            <arg value="${code.analysis.internal.linter-option}"/>
            <arg value='${code.analysis.internal.linter-option.value}'/>
            <arg value="${code.analysis.input.dir}"/>
        </exec>
    </target>

    <!-- Install istanbul -->
    <target name="install_plato">
        <if>
            <equals arg1="${general.installNeededSoftware}" arg2="true" />
            <then>
                <exec executable="cmd" osfamily="windows" failonerror="true">
                    <arg line="/c npm install --prefix ${TOOLS-DIR} plato" />
                </exec>
                <exec executable="bash" osfamily="unix" failonerror="true">
                    <arg line="-c" />
                    <arg value="npm install --prefix ${TOOLS-DIR} plato"/>
                </exec>
            </then>
            <else>
                <echo level="info" message="Install of software disabled from config, trying to execute PLATO" />
            </else>
        </if>
    </target>

</project>
